# Анализ: отчёт Instagram export → dist

Анализ сгенерированного Markdown-файла в `dist/` (например `*_notebooklm.md`): нечитаемые символы, возможные улучшения и соответствие требованиям NotebookLM.

---

## 1. Нечитаемые и проблемные символы

### 1.1 NEL (U+0085) — Next Line

- **Количество в выборке:** ~34 277 вхождений.
- **Причина:** В экспорте Instagram в тексте сообщений, именах отправителей или в шаринге иногда встречается символ **U+0085 (NEL, «Next Line»)**. При записи в MD он ведёт себя как нестандартный перевод строки.
- **Эффект:** Часть редакторов и просмотрщиков воспринимает NEL как перенос строки или показывает его как невидимый/странный символ. Файл определяется как «UTF-8 text, with LF, **NEL** line terminators».
- **Исправление (внедрено):** При сборке отчёта весь текст, попадающий в вывод, нормализуется: NEL, CR (`\r`) и при необходимости U+2028/U+2029 заменяются на пробел. Так в dist остаются только обычные пробелы и переводы строк LF.

### 1.2 Символ замены (U+FFFD)

- **Количество в выборке:** 9.
- **Причина:** Ошибки декодирования — во входных данных встречался невалидный UTF-8 (или другая кодировка), и Python подставил символ замены U+FFFD.
- **Что делать:** Читать все JSON/файлы с `encoding="utf-8"`. Оставшиеся U+FFFD в выводе означают повреждённые или неверно закодированные данные в самом экспорте.

### 1.3 Моибайк (например `Ð¡`, `Ð½` вместо кириллицы)

- **Наблюдение:** Во многих строках кириллица отображается как кракозябры: `Ð¡Ð¼ÐµÑÐ½Ð°Ñ` вместо «Смешная», `Stanislava ð³` вместо имени с эмодзи. В других строках тот же текст отображается нормально (например «У меня тоже…», «Поделился ссылкой: …»).
- **Причина:** **Двойная кодировка** — байты UTF-8 были в какой-то момент прочитаны как Latin-1 (или аналог) и снова сохранены как UTF-8. Возможно из-за экспорта Instagram для части локалей или способа хранения имён/контента.
- **Исправление (опционально в следующей версии):**  
  - Читать JSON с `errors="replace"`, чтобы не падать на битых байтах.  
  - Опционально пытаться исправлять типичный моибайк: если строка похожа на UTF-8, прочитанный как Latin-1 (например есть паттерн `Ð`), пробовать `s.encode("latin-1").decode("utf-8")`. Эвристика, лучше сделать опцией.

---

## 2. Что можно улучшить в следующей генерации

### 2.1 Нормализация текста (сделано)

- Нормализовать **NEL (U+0085)**, **CR** и при необходимости **U+2028 / U+2029** во всех строках, попадающих в MD (текст сообщений, имена отправителей, имена чатов и т.д.), чтобы в dist были только обычные пробелы и переводы строк LF.

### 2.2 Кодировка и моибайк

- Оставить **UTF-8** для всего чтения/записи; добавить опциональное **исправление моибайка** для кириллицы/двойной кодировки (с флагом отключения).
- Описать в документации: появление **U+FFFD** в выводе означает невалидные байты в исходном экспорте.

### 2.3 Структура и читаемость

- **Длинные строки:** В файле есть очень длинные строки (например длинные блоки хештегов). Имеет смысл ограничивать длину или обрезать с «…» для читаемости и совместимости с инструментами.
- **Разделы:** Более явное разделение между чатами (например `---` или короткий заголовок), чтобы удобнее ориентироваться в больших экспортах и в NotebookLM.

### 2.4 Размер и лимиты NotebookLM

- **Один большой файл:** Один MD на десятки тысяч строк может превысить лимиты NotebookLM или замедлить работу. Варианты:
  - Разбивать по разделам (например отдельный файл на крупный чат, «Профиль + связи» в одном файле).
  - Разбивать по числу слов (~450–500k слов на файл), по аналогии с экспортером Telegram.

### 2.5 Контент

- **Реакции:** Уже выводятся как `(Автор: реакция)`. При необходимости можно нормализовать или обрезать эмодзи в реакциях.
- **«Liked a message» / «Reacted …»:** Уже включены; по желанию можно группировать или сокращать для уменьшения шума.
- **Редактирование:** Если в экспорте Instagram есть пометка «(edited)» или аналог, её можно явно выводить в строке сообщения.

---

## 3. Соответствие требованиям NotebookLM

Официальные ограничения NotebookLM (на один источник):

- **Объём:** не более **500 000 слов** или **200 МБ** на источник;
- Формат: поддерживаются в том числе загружаемые файлы (PDF, текст, и т.д.). Markdown допускается.

### Проверка текущего dist-файла

| Параметр        | Лимит NotebookLM | Текущий файл (*_notebooklm.md) | Соответствие |
|-----------------|-------------------|---------------------------------|--------------|
| Слов            | ≤ 500 000         | **~899 852**                    | **Превышен** |
| Размер файла    | ≤ 200 МБ          | ~10,4 МБ                        | Ок           |
| Строк           | —                 | ~67 600                         | —            |

**Вывод:** Текущий единый MD-файл **не соответствует** лимиту NotebookLM по числу слов: в нём почти 900k слов при лимите 500k. Такой источник NotebookLM не примет или обрежет.

**Рекомендации:**

1. **Разбивать вывод на части по ~450–500k слов** (как в экспортере Telegram), чтобы каждый файл можно было загружать в NotebookLM отдельным источником.
2. Либо разбивать по разделам (профиль + связи; переписки по чатам; активность; темы) и при необходимости дополнительно резать большие чаты по объёму слов.

После внедрения разбиения каждый кусок будет соответствовать лимиту и корректно загружаться в NotebookLM.

---

## 4. Что ещё можно улучшить в импорте (приоритеты)

| Приоритет | Улучшение | Зачем | Сложность |
|-----------|-----------|--------|-----------|
| **Высокий** | Разбивать вывод на части по ~450–500k слов | NotebookLM не примет один файл >500k слов | **Сделано:** `--max-words 450000`, при превышении пишутся `*_notebooklm_1.md`, `*_2.md`, … |
| **Высокий** | Опция разбивки по разделам (профиль+связи; чаты по одному файлу; активность; темы) | Гибкая загрузка в NotebookLM, быстрый поиск | Опционально (пока разрез по словам/строкам) |
| Средний | Обрезка слишком длинных строк (напр. 1500–2000 символов + «…») | Читаемость, совместимость с инструментами | Низкая |
| Средний | Разделитель `---` между чатами | Удобнее ориентироваться в большом MD | Низкая |
| Средний | Чтение JSON с `errors="replace"` | Не падать на битых байтах в экспорте | Низкая |
| Низкий | Флаг `--no-fix-mojibake` для отключения автоисправления кракозябр | Если эвристика мешает редким строкам | Низкая |
| Низкий | Вывод пометки «(edited)» для отредактированных сообщений | Если Instagram отдаёт это в JSON | Низкая |
| Низкий | Сокращение шума: «Liked a message» / «Reacted …» — группировать или сокращать | Меньше мусора в dist | Низкая |

---

## Итоговая таблица

| Проблема                 | Причина                           | Статус / рекомендация                 |
|--------------------------|------------------------------------|----------------------------------------|
| NEL (U+0085) в выводе    | В JSON Instagram встречается NEL   | **Исправлено:** нормализация в скрипте |
| U+FFFD                   | Невалидный UTF-8 во входе          | UTF-8 везде; остаточные — в экспорте   |
| Моибайк (Ð…)             | Двойная кодировка кириллицы       | **Сделано:** эвристика в скрипте       |
| Очень длинные строки     | Длинные хештеги/контент           | **Опционально:** обрезка или перенос   |
| Один огромный файл       | Всё в одном MD                    | **Нужно:** разбиение по словам/разделам для NotebookLM |
| Лимит 500k слов          | Требование NotebookLM              | **Не соблюдён:** ~900k слов → нужна разбивка |
