# Анализ: отчёт Instagram export → dist

Анализ сгенерированного Markdown-файла в `dist/` (например `*_notebooklm.md`): нечитаемые символы, возможные улучшения и соответствие требованиям NotebookLM.

---

## 1. Нечитаемые и проблемные символы

### 1.1 NEL (U+0085) — Next Line

- **Количество в выборке:** ~34 277 вхождений.
- **Причина:** В экспорте Instagram в тексте сообщений, именах отправителей или в шаринге иногда встречается символ **U+0085 (NEL, «Next Line»)**. При записи в MD он ведёт себя как нестандартный перевод строки.
- **Эффект:** Часть редакторов и просмотрщиков воспринимает NEL как перенос строки или показывает его как невидимый/странный символ. Файл определяется как «UTF-8 text, with LF, **NEL** line terminators».
- **Исправление (внедрено):** При сборке отчёта весь текст, попадающий в вывод, нормализуется: NEL, CR (`\r`) и при необходимости U+2028/U+2029 заменяются на пробел. Так в dist остаются только обычные пробелы и переводы строк LF.

### 1.2 Символ замены (U+FFFD)

- **Количество в выборке:** 9.
- **Причина:** Ошибки декодирования — во входных данных встречался невалидный UTF-8 (или другая кодировка), и Python подставил символ замены U+FFFD.
- **Что делать:** Читать все JSON/файлы с `encoding="utf-8"`. Оставшиеся U+FFFD в выводе означают повреждённые или неверно закодированные данные в самом экспорте.

### 1.3 Моибайк (например `Ð¡`, `Ð½` вместо кириллицы)

- **Наблюдение:** Во многих строках кириллица отображается как кракозябры: `Ð¡Ð¼ÐµÑÐ½Ð°Ñ` вместо «Смешная», `Stanislava ð³` вместо имени с эмодзи. В других строках тот же текст отображается нормально (например «У меня тоже…», «Поделился ссылкой: …»).
- **Причина:** **Двойная кодировка** — байты UTF-8 были в какой-то момент прочитаны как Latin-1 (или аналог) и снова сохранены как UTF-8. Возможно из-за экспорта Instagram для части локалей или способа хранения имён/контента.
- **Исправление (опционально в следующей версии):**  
  - Читать JSON с `errors="replace"`, чтобы не падать на битых байтах.  
  - Опционально пытаться исправлять типичный моибайк: если строка похожа на UTF-8, прочитанный как Latin-1 (например есть паттерн `Ð`), пробовать `s.encode("latin-1").decode("utf-8")`. Эвристика, лучше сделать опцией.

---

## 2. Что можно улучшить в следующей генерации

### 2.1 Нормализация текста (сделано)

- Нормализовать **NEL (U+0085)**, **CR** и при необходимости **U+2028 / U+2029** во всех строках, попадающих в MD (текст сообщений, имена отправителей, имена чатов и т.д.), чтобы в dist были только обычные пробелы и переводы строк LF.

### 2.2 Кодировка и моибайк

- Оставить **UTF-8** для всего чтения/записи; добавить опциональное **исправление моибайка** для кириллицы/двойной кодировки (с флагом отключения).
- Описать в документации: появление **U+FFFD** в выводе означает невалидные байты в исходном экспорте.

### 2.3 Структура и читаемость

- **Длинные строки:** В файле есть очень длинные строки (например длинные блоки хештегов). Имеет смысл ограничивать длину или обрезать с «…» для читаемости и совместимости с инструментами.
- **Разделы:** Более явное разделение между чатами (например `---` или короткий заголовок), чтобы удобнее ориентироваться в больших экспортах и в NotebookLM.

### 2.4 Размер и лимиты NotebookLM

- **Один большой файл:** Один MD на десятки тысяч строк может превысить лимиты NotebookLM или замедлить работу. Варианты:
  - Разбивать по разделам (например отдельный файл на крупный чат, «Профиль + связи» в одном файле).
  - Разбивать по числу слов (~450–500k слов на файл), по аналогии с экспортером Telegram.

### 2.5 Контент

- **Реакции:** Уже выводятся как `(Автор: реакция)`. При необходимости можно нормализовать или обрезать эмодзи в реакциях.
- **«Liked a message» / «Reacted …»:** Уже включены; по желанию можно группировать или сокращать для уменьшения шума.
- **Редактирование:** Если в экспорте Instagram есть пометка «(edited)» или аналог, её можно явно выводить в строке сообщения.

---

## 3. Соответствие требованиям NotebookLM

Официальные ограничения NotebookLM (на один источник):

- **Объём:** не более **500 000 слов** или **200 МБ** на источник;
- Формат: поддерживаются в том числе загружаемые файлы (PDF, текст, и т.д.). Markdown допускается.

### Проверка текущего dist-файла

| Параметр        | Лимит NotebookLM | Текущий файл (*_notebooklm.md) | Соответствие |
|-----------------|-------------------|---------------------------------|--------------|
| Слов            | ≤ 500 000         | **~899 852**                    | **Превышен** |
| Размер файла    | ≤ 200 МБ          | ~10,4 МБ                        | Ок           |
| Строк           | —                 | ~67 600                         | —            |

**Вывод:** Текущий единый MD-файл **не соответствует** лимиту NotebookLM по числу слов: в нём почти 900k слов при лимите 500k. Такой источник NotebookLM не примет или обрежет.

**Рекомендации:**

1. **Разбивать вывод на части по ~450–500k слов** (как в экспортере Telegram), чтобы каждый файл можно было загружать в NotebookLM отдельным источником.
2. Либо разбивать по разделам (профиль + связи; переписки по чатам; активность; темы) и при необходимости дополнительно резать большие чаты по объёму слов.

После внедрения разбиения каждый кусок будет соответствовать лимиту и корректно загружаться в NotebookLM.

---

## 4. Что ещё можно улучшить в импорте (приоритеты)

| Приоритет | Улучшение | Зачем | Сложность |
|-----------|-----------|--------|-----------|
| **Высокий** | Разбивать вывод на части по ~450–500k слов | NotebookLM не примет один файл >500k слов | **Сделано:** `--max-words 450000`, при превышении пишутся `*_notebooklm_1.md`, `*_2.md`, … |
| **Высокий** | Опция разбивки по разделам (профиль+связи; чаты по одному файлу; активность; темы) | Гибкая загрузка в NotebookLM, быстрый поиск | Опционально (пока разрез по словам/строкам) |
| Средний | Обрезка слишком длинных строк (напр. 1500–2000 символов + «…») | Читаемость, совместимость с инструментами | Низкая |
| Средний | Разделитель `---` между чатами | Удобнее ориентироваться в большом MD | Низкая |
| Средний | Чтение JSON с `errors="replace"` | Не падать на битых байтах в экспорте | Низкая |
| Низкий | Флаг `--no-fix-mojibake` для отключения автоисправления кракозябр | Если эвристика мешает редким строкам | Низкая |
| Низкий | Вывод пометки «(edited)» для отредактированных сообщений | Если Instagram отдаёт это в JSON | Низкая |
| Низкий | Сокращение шума: «Liked a message» / «Reacted …» — группировать или сокращать | Меньше мусора в dist | Низкая |

---

## Итоговая таблица

| Проблема                 | Причина                           | Статус / рекомендация                 |
|--------------------------|------------------------------------|----------------------------------------|
| NEL (U+0085) в выводе    | В JSON Instagram встречается NEL   | **Исправлено:** нормализация в скрипте |
| U+FFFD                   | Невалидный UTF-8 во входе          | UTF-8 везде; остаточные — в экспорте   |
| Моибайк (Ð…)             | Двойная кодировка кириллицы       | **Сделано:** эвристика в скрипте       |
| Очень длинные строки     | Длинные хештеги/контент           | **Опционально:** обрезка или перенос   |
| Один огромный файл       | Всё в одном MD                    | **Нужно:** разбиение по словам/разделам для NotebookLM |
| Лимит 500k слов          | Требование NotebookLM              | **Исправлено:** разбиение по 450k слов → `*_notebooklm_1.md`, `*_2.md` |

---

## 5. Анализ текущего dist (февраль 2026)

Проверена папка `dist/instagram-br_hum4n-2026-02-04-DHYBumLm/`: два файла после разбиения по словам.

### 5.1 Состояние разбиения

| Файл | Строк | Содержимое |
|------|--------|------------|
| `*_notebooklm_1.md` | ~22 580 | Заголовок, Профиль, Социальные связи, Переписки (начало) — обрез по лимиту слов в середине чата. |
| `*_notebooklm_2.md` | ~31 002 | Заголовок «часть 2 из 2», далее сразу строки сообщений без заголовка чата; ближе к концу — новые «### Чат: …», затем Активность, Повторяющиеся темы. |

**Проблема:** В части 2 первые ~29 000 строк — продолжение переписок без секции «### Чат: …». При открытии части 2 непонятно, какой это чат (контекст есть только в части 1). В части 1 последние строки — один и тот же диалог (Stanislava, Maks Human), в части 2 с первой строки идёт тот же диалог, но заголовка «### Чат: Stanislava ð³, Maks Human» нет.

**Рекомендация:** При разбиении по словам, если разрез попадает внутрь блока переписок, в начало следующей части добавлять строку вида  
`### Продолжение: Чат: Имя1, Имя2`  
(имя текущего чата нужно передавать в `_split_md_by_words` или определять по последней строке «### Чат:» перед разрезом).

### 5.2 Сломанные эмодзи (новый тип моибайка)

- **Наблюдение:** В части 2 в ~18 465 строках встречаются последовательности `ð` и `â` в именах отправителей, в тексте сообщений и в реакциях:
  - `Stanislava ð³` — эмодзи в имени (например черепаха) отображается как кракозябры;
  - `â¤` — сломанное отображение ❤️ в реакциях;
  - `âºï¸` — сломанное отображение ☕️;
  - `ð`, `ð` и т.п. — сломанные эмодзи в тексте.
- **Причина:** Эмодзи в JSON экспорта Instagram хранятся/отдаются в кодировке, которая при чтении как UTF-8 даёт не те байты (или часть байтов теряется/подменяется). Текущая эвристика `_maybe_fix_mojibake` исправляет только паттерн Ð/Ñ (кириллица, прочитанная как Latin-1), но не последовательности вида `ð`/`â` + байты, соответствующие обрезанному UTF-8 эмодзи.
- **Что делать:**  
  - Вариант A: добавить словарь частых сломанных последовательностей → заменять на корректный эмодзи (например `â¤` → ❤️).  
  - Вариант B: детектировать «битые» UTF-8 последовательности в диапазоне эмодзи и заменять их на один символ-заполнитель, например `[emoji]`, чтобы не засорять текст.  
  - Вариант C: при чтении JSON проверять, не приходят ли поля (sender_name, reaction, share_text и т.д.) в другой кодировке для части записей; при необходимости пробовать `encode("latin-1").decode("utf-8")` только для полей с `ð`/`â` (осторожно с ложными срабатываниями).

### 5.3 Шум от служебных сообщений

- В части 2 одна только фраза «Liked a message» встречается **~847** раз. Плюс «Reacted … to your message». Для NotebookLM и для чтения это создаёт шум.
- **Рекомендация (уже в приоритетах):** опция `--collapse-actions` или аналог: подряд идущие «Liked a message» / «Reacted …» либо не выводить, либо заменять одной строкой вида «— Несколько лайков/реакций подряд» и т.п.

### 5.4 Структура части 2

- В части 2 заголовки `## Активность`, `### Лайки постов`, `### Мои комментарии`, `## Повторяющиеся темы` присутствуют и выглядят корректно. Разделы не дублируются между частями. Единственный структурный минус — отсутствие контекста чата в начале части 2 (см. п. 5.1).

---

## 6. Дополнительные улучшения для будущих генераций

| Приоритет | Улучшение | Зачем | Сложность |
|-----------|-----------|--------|------------|
| **Высокий** | В начало части 2+ при разрезе внутри переписок добавлять «### Продолжение: Чат: X» | В части 2 сразу понятно, какой чат читаешь | Средняя (передавать контекст чата в логику разбиения) |
| **Средний** | Исправление или замена сломанных эмодзи (`ð…`, `â…`) в именах, реакциях и тексте | Читаемые имена и реакции, меньше мусора в поиске | Средняя (словарь или эвристика по байтам) |
| Средний | Опция сокращения «Liked a message» / «Reacted …» (группировка или пропуск) | Меньше шума, компактнее документ | Низкая |
| Низкий | Разбиение по разделам (профиль+связи; чаты по файлу; активность; темы) | Гибкая загрузка в NotebookLM | Средняя |
| Низкий | Обрезка длинных строк (уже есть MAX_MESSAGE_LINE_CHARS=2000), при желании уменьшить до 1500 | Ещё лучше совместимость с инструментами | Низкая |

---

## Итоговая таблица (актуальная)

| Проблема | Причина | Статус / рекомендация |
|----------|---------|------------------------|
| NEL (U+0085) в выводе | В JSON Instagram встречается NEL | **Исправлено:** нормализация в скрипте |
| U+FFFD | Невалидный UTF-8 во входе | UTF-8 везде; остаточные — в экспорте |
| Моибайк кириллицы (Ð…) | Двойная кодировка | **Исправлено:** эвристика в скрипте |
| Сломанные эмодзи (ð/â) | Иной способ хранения эмодзи в экспорте | **Новое:** словарь/эвристика или замена на [emoji] |
| Очень длинные строки | Длинные хештеги/контент | **Сделано:** обрезка MAX_MESSAGE_LINE_CHARS=2000 |
| Один огромный файл | Всё в одном MD | **Исправлено:** разбиение по 450k слов |
| Лимит 500k слов | Требование NotebookLM | **Исправлено:** части по ≤450k слов |
| Контекст чата в части 2+ | Разрез по словам в середине чата | **Новое:** добавлять «### Продолжение: Чат: X» в начало части |
| Шум «Liked a message» | Много служебных строк | Опционально: группировать/сокращать |
